# 人脸几何特征提取与分析）

> 精确、可视化的人脸下颌/侧角度测量与下半面宽度计算  
> 支持 **补角（大角）弧线绘制**、**厘米(cm)标注**、**局部放大+平移** 的交互式 GUI

---

## 🚀 本版亮点（What's New）
- **侧角度 = 补角（大角）**：从基准下颌切线与上侧支撑切线的交点 **S** 处绘制**大弧**，角度数值与弧线一致（≥90°）。  
- **下半面宽度**：沿**嘴角水平线**与脸颊轮廓的左右交点间的距离，**仅输出 cm**，并在图像中间位置**叠加“xx.xx cm”标注**。  
- **稳健的轮廓回退**：若颜色分割未得到可靠脸型轮廓，自动回退到 **dlib 0–16 号下颌关键点**（不再报错 `No face contour detected`）。  
- **更稳健的 S 点求交**：当基准切线近似水平时也能正确找到 S。  
- **GUI 局部放大**：显示区域大小不变，**左键单击设中心、右键拖动平移**，滑条控制倍率（1.0–4.0）。  

---

## ✨ 功能概述
- 人脸检测 & 68 点关键点（dlib）  
- 人脸中线：以 **x = a·y + b** 的线性回归拟合（更适应轻微头部倾斜）  
- 嘴角水平线（A 方案）  
- 基准下颌切线（左右各一）：基于下颌关键点局部最小二乘拟合  
- **侧角度（补角）**：以基准切线与嘴角水平线交点 **S** 为外点，向上侧（颧/面颊方向）作**支撑切线**，与基准切线的**补角**（**在图上绘制大弧**）  
- **下半面宽度（cm）**：嘴角水平线与脸颊轮廓的左右交点间的真实长度（基于同一设备/同一水平行的参考真实宽度，默认 **17 cm = 170 mm**）  
- 结果图像叠加：中线、平行线、嘴角水平线、基准切线、支撑切线、交点 S、**角度弧线与数值**、**下半面线与 cm 标注**  
- GUI 交互：参数微调、局部放大、局部平移、结果保存、指标面板（下半面宽度 cm、左/右侧角度（补角））

---

## 📦 一键运行（Windows 可执行程序）
已打包的 Windows 可执行文件位于：  
`dist/gui_app/gui_app.exe`  

双击运行即可（无需本地安装 Python 依赖）。首次运行如出现安全拦截，选择“仍要运行”。  
> 注：运行时需携带 `model/shape_predictor_68_face_landmarks.dat`（见下文“模型文件”）。

---

## 🧪 从源码运行（可选）
### 1) 准备环境
推荐使用 conda：
```bash
conda create -n face_app python=3.9 -y
conda activate face_app

# 依赖（conda-forge）
conda install -c conda-forge numpy opencv dlib scipy -y
```
或使用 pip（需本机已能编译 dlib）:
```bash
pip install numpy opencv-python dlib scipy
```

### 2) 模型文件
下载 dlib 预训练模型：`shape_predictor_68_face_landmarks.dat`  
放置路径：`model/shape_predictor_68_face_landmarks.dat`  
> EXE 打包版同样需要此文件（若已内置则可忽略）。

### 3) 运行 GUI
```bash
python gui_app.py
```

---

## 🧠 核心算法说明

### 1) 人脸中线（Midline）
- 使用关键点 {27, 28, 29, 30, 8}，以 **x = a·y + b** 做线性回归，得到中线方向向量 `mid_vec`。

### 2) 基准下颌切线（左右）
- 左侧：关键点 {3..8}，右侧：{8..13}，分别做 **x = m·y + b** 的线性回归，得到两条**基准切线**。

### 3) 嘴角水平线 & 交点 S
- 嘴角水平线：`y = (y(48) + y(54)) / 2`。  
- 交点 S：基准切线与该水平线相交。若基准切线近水平，则取 `S = (P0.x, y_mouth)`。

### 4) 上侧支撑切线（新切线）
- 以 S 为外点，枚举脸型轮廓上的上侧点，判定 **所有轮廓点在直线同侧** → 为“支撑线”。取距离 S 最近的支撑点生成“新切线”。若严格支撑点不存在，则**回退**为“上侧最近点”。

### 5) 侧角度（补角，大弧）
- 以 `v0=基准切线方向`、`vs=新切线方向`，原始夹角 `θ=acos(clip(dot(v0,vs)))`。  
- **补角**：`θ_obtuse = 180° - min(θ, 180°-θ)`（≥90°）。  
- 绘弧时将一条射线反向（+180°）再绘**短路径**弧，使弧长 = `θ_obtuse`，实现**大弧**视觉效果。

### 6) 下半面宽度（cm）
- 嘴角水平线与脸型轮廓的左右交点间像素距离 `d_px`。  
- 因拍摄在同一设备同一水平行，已知该**图像宽度对应实宽**（默认 170 mm，支持 GUI 输入），换算：`mm_per_px = real_width_mm / image_width_px`，  
- `d_cm = d_px * mm_per_px / 10`。仅输出 **cm**，并在图像中部**标注“xx.xx cm”**。

---

## 🖥 界面与交互
- **选择图片** → **参考真实宽度(mm)**（默认 170） → **处理图片**  
- **几何量**面板：显示 *下半面宽度（cm）*、*左/右侧角度（补角，°）*  
- **局部放大**：
  - 滑条：倍率 1.0–4.0（**显示区域大小不变**）  
  - **左键单击**结果图：设定放大中心  
  - **右键拖动**：平移放大窗口  
- **保存图片**：导出叠加标注后的分析结果（原始分辨率）

**颜色约定（默认样式）**  
- 中线：洋红（Magenta）  
- 嘴角水平线：青色  
- 过嘴角的平行线：黄色  
- 基准下颌切线：红色  
- 上侧支撑切线：橙色  
- 交点 S：紫色圆点  
- 侧角度弧线与文本：与对应切线同色（大弧）  
- 下半面线与“xx.xx cm”：红/蓝（视当前实现）


## 🤝 贡献
欢迎提交 Issue / PR，或提出算法与交互改进建议。
